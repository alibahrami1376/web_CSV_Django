{% extends 'base.html' %}

{% block header %}
  {% if user.is_authenticated %}
    {% if user.profile %}
      <portfolio-header
        data-is-auth="true"
        data-avatar="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% endif %}"
        data-profile-url="{% url 'home:profile' %}"
        data-variant="home"
        data-home-url="#home"
        data-about-url="#about"
        data-education-url="#education"
        data-languages-url="#languages"
        data-skills-url="#skills"
        data-projects-url="#projects"
        data-contact-url="#contact"
        data-blog-url="{% url 'blog:blog_home' %}"
        data-logo-url="#home"
      ></portfolio-header>
    {% else %}
      <portfolio-header
        data-is-auth="true"
        data-variant="home"
        data-home-url="#home"
        data-about-url="#about"
        data-education-url="#education"
        data-languages-url="#languages"
        data-skills-url="#skills"
        data-projects-url="#projects"
        data-contact-url="#contact"
        data-blog-url="{% url 'blog:blog_home' %}"
        data-logo-url="#home"
      ></portfolio-header>
    {% endif %}
  {% else %}
    <portfolio-header
      data-is-auth="false"
      data-variant="home"
      data-home-url="#home"
      data-about-url="#about"
      data-education-url="#education"
      data-languages-url="#languages"
      data-skills-url="#skills"
      data-projects-url="#projects"
      data-contact-url="#contact"
      data-blog-url="{% url 'blog:blog_home' %}"
      data-logo-url="#home"
    ></portfolio-header>
  {% endif %}
{% endblock %}

{% block content %}

<main>
  <!-- Home Section -->
  <section id="home" class="hero-section">
    <div class="hero-content">
      <div class="profile-image-container">
        <img
          src="{{ content.hero.profile_image }}"
          alt="Profile Picture"
          class="profile-image"
        />
      </div>
      <h1 class="hero-title">{{ content.hero.title }}</h1>
      <div class="hero-subtitle">
        {% for role in content.hero.roles %}
        <span>{{ role }}</span>
        {% if not forloop.last %}
        <span class="separator">|</span>
        {% endif %} {% endfor %}
      </div>
      <div class="hero-buttons">
        {% for button in content.hero.buttons %}
        <a href="{{ button.href }}" class="btn btn-{{ button.variant }}">
          <span>{{ button.label }}</span>
          {% if button.variant == 'primary' %}
          <i data-feather="mail"></i>
          {% else %}
          <i data-feather="briefcase"></i>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- About / Biography Section -->
  <section id="about" class="section">
    <div class="container">
      <h2 class="section-title">{{ content.about.title }}</h2>
      <div class="about-content">
        <div class="about-text">
          {% for paragraph in content.about.paragraphs %}
          <p>{{ paragraph }}</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <!-- Education Section -->
  <section id="education" class="section">
    <div class="container">
      <h2 class="section-title">{{ content.education.title }}</h2>
      <div class="education-timeline">
        {% for item in content.education.items %}
        <div class="education-item">
          <div class="education-icon">
            <i data-feather="{{ item.icon }}"></i>
          </div>
          <div class="education-content">
            <h3>{{ item.title }}</h3>
            <p class="education-institution">{{ item.institution }}</p>
            <p class="education-period">{{ item.period }}</p>
            <p class="education-description">{{ item.description }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Languages Section -->
  <section id="languages" class="section">
    <div class="container">
      <h2 class="section-title">{{ content.languages.title }}</h2>
      <div class="languages-grid">
        {% for language in content.languages.items %}
        <div class="language-item" data-language-index="{{ forloop.counter0 }}" data-writing="{{ language.writing }}" data-speaking="{{ language.speaking }}" data-listening="{{ language.listening }}">
          <div class="language-header">
            <div class="language-name">
              <i data-feather="globe"></i>
              <span>{{ language.name }}</span>
            </div>
            <div class="language-level">
              <span class="level-text">{{ language.level_text }}</span>
              <div class="level-bar">
                <div
                  class="level-fill"
                  style="width: {{ language.proficiency }}%"
                ></div>
              </div>
            </div>
            <div class="language-toggle">
              <i data-feather="chevron-down" class="toggle-icon"></i>
            </div>
          </div>
          <div class="language-details">
            <div class="language-skill">
              <div class="skill-header">
                <span class="skill-label">
                  <i data-feather="edit-3"></i>
                  نوشتن (Writing)
                </span>
                <span class="skill-percentage">{{ language.writing }}%</span>
              </div>
              <div class="skill-bar">
                <div class="skill-fill" data-width="{{ language.writing }}" style="width: 0%"></div>
              </div>
            </div>
            <div class="language-skill">
              <div class="skill-header">
                <span class="skill-label">
                  <i data-feather="mic"></i>
                  صحبت کردن (Speaking)
                </span>
                <span class="skill-percentage">{{ language.speaking }}%</span>
              </div>
              <div class="skill-bar">
                <div class="skill-fill" data-width="{{ language.speaking }}" style="width: 0%"></div>
              </div>
            </div>
            <div class="language-skill">
              <div class="skill-header">
                <span class="skill-label">
                  <i data-feather="headphones"></i>
                  شنیدن (Listening)
                </span>
                <span class="skill-percentage">{{ language.listening }}%</span>
              </div>
              <div class="skill-bar">
                <div class="skill-fill" data-width="{{ language.listening }}" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Skills Section -->
  <section id="skills" class="section">
    <div class="container">
      <h2 class="section-title">{{ content.skills.title }}</h2>
      <div class="skills-grid">
        {% for skill in content.skills.items %}
        <div class="skill-card">
          <i data-feather="{{ skill.icon }}"></i>
          <h3>{{ skill.title }}</h3>
          <p>{{ skill.description }}</p>
          <div class="skill-tags">
            {% for tag in skill.tags %}
            <span>{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Projects Section -->
  <section id="projects" class="section">
    <div class="container">
      <h2 class="section-title">پروژه ها</h2>
      <div class="projects-grid">
        {% for project in projects %}
        <div class="project-card">
          <div class="project-image">
            {% if project.image %}
            <img src="{{ project.image.url }}" alt="{{ project.title }}" />
            {% else %}
            <div class="project-image-placeholder">
              <i data-feather="image"></i>
            </div>
            {% endif %}
            {% if project.featured %}
            <div class="project-featured">
              <i data-feather="star"></i>
              <span>ویژه</span>
            </div>
            {% endif %}
            <div class="project-status project-status-{{ project.status }}">
              <i data-feather="{% if project.status == 'completed' %}check-circle{% elif project.status == 'in_progress' %}clock{% else %}pause-circle{% endif %}"></i>
              <span>{{ project.get_status_display }}</span>
            </div>
          </div>
          <div class="project-content">
            <h3>{{ project.title }}</h3>
            <p>{{ project.description }}</p>
            <div class="project-tags">
              {% for cat in project.category.all %}
              <span>{{ cat.name }}</span>
              {% endfor %}
            </div>
            <div class="project-links">
              {% if project.website_url %}
              <a href="{{ project.website_url }}" class="project-link project-link-demo" target="_blank" rel="noopener noreferrer">
                مشاهده وب‌سایت
                <i data-feather="arrow-left"></i>
              </a>
              {% endif %}
              {% if project.github_url %}
              <a href="{{ project.github_url }}" class="project-link project-link-github" target="_blank" rel="noopener noreferrer">
                GitHub
                <i data-feather="github"></i>
              </a>
              {% endif %}
              {% if project.demo_url %}
              <a href="{{ project.demo_url }}" class="project-link project-link-demo" target="_blank" rel="noopener noreferrer">
                دمو
                <i data-feather="external-link"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p style="text-align: center; grid-column: 1 / -1; padding: 2rem; color: var(--text-secondary-color);">هیچ پروژه‌ای یافت نشد.</p>
        {% endfor %}
      </div>
      <div class="projects-view-all">
        <a href="{% url 'projects:projects_list' %}" class="view-all-link">
          <span>مشاهده همه پروژه‌ها</span>
          <i data-feather="arrow-left"></i>
        </a>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section id="contact" class="section">
    <div class="container">
      <h2 class="section-title">{{ content.contact.title }}</h2>
      
      <!-- نمایش پیام‌های Django messages -->
      {% if messages %}
        <div class="messages-container">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      
      <div class="contact-content">
        <div class="contact-info">
          <h3>{{ content.contact.intro_title }}</h3>
          <p>{{ content.contact.intro_text }}</p>
          <div class="contact-details">
            {% for detail in content.contact.details %}
            <div class="contact-item">
              <i data-feather="{{ detail.icon }}"></i>
              <div>
                <strong>{{ detail.label }}</strong>
                <span>{{ detail.value }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <form class="contact-form" id="contactForm" method="POST" action="{% url 'home:save_contact' %}">
          {% csrf_token %}

          
          {% for field in content.contact.form.fields %}
          <div class="form-group">
            <label for="{{ field.id }}">{{ field.label }}</label>

            {% if field.type == 'textarea' %}
            <textarea
              id="{{ field.id }}"
              name="{{ field.id }}"
              required
            ></textarea>
            {% else %}
            <input
              type="{{ field.type }}"
              id="{{ field.id }}"
              name="{{ field.id }}"
              required
            />
            {% endif %}
          </div>
          {% endfor %}

          <button type="button" id="submitBtn" class="btn btn-primary" onclick="handleSubmitClick(event)">
            <span>{{ content.contact.form.submit_label }}</span>
            <i data-feather="send"></i>
          </button>
        </form>
      </div>
    </div>
  </section>
</main>

<!-- مودال کپچا -->
<div id="captchaModal" class="captcha-modal" style="display: none;">
  <div class="captcha-modal-overlay"></div>
  <div class="captcha-modal-content">
    <div class="captcha-modal-header">
      <h3>تأیید امنیتی</h3>
      <button type="button" class="captcha-modal-close" id="closeCaptchaModal">
        <i data-feather="x"></i>
      </button>
    </div>
    <div class="captcha-modal-body">
      <p>لطفاً کد امنیتی زیر را وارد کنید:</p>
      <div id="captchaFieldContainer">
        {% if contact_form %}
        {{ contact_form.captcha }}
        {% else %}
        <p style="color: red;">خطا: فرم کپچا یافت نشد. لطفاً صفحه را رفرش کنید.</p>
        {% endif %}
      </div>
      <div class="captcha-modal-actions">
        <button type="button" class="btn btn-secondary" id="cancelCaptchaBtn">
          <span>انصراف</span>
          <i data-feather="x"></i>
        </button>
        <button type="button" class="btn btn-primary" id="confirmCaptchaBtn">
          <span>تأیید و ارسال</span>
          <i data-feather="check"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* استایل‌های پیام‌ها */
  .messages-container {
    margin-bottom: 2rem;
    max-width: 100%;
  }

  .alert {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.95rem;
    text-align: center;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert-success {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.3);
  }

  .alert-error {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.3);
  }

  .alert-info {
    background-color: rgba(33, 150, 243, 0.1);
    color: #2196f3;
    border: 1px solid rgba(33, 150, 243, 0.3);
  }

  .alert-warning {
    background-color: rgba(255, 152, 0, 0.1);
    color: #ff9800;
    border: 1px solid rgba(255, 152, 0, 0.3);
  }

  .captcha-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .captcha-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .captcha-modal-content {
    position: relative;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 10001;
  }

  .dark-theme .captcha-modal-content {
    background: var(--surface-color);
  }

  .captcha-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .captcha-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-color);
  }

  .captcha-modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--text-secondary-color);
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .captcha-modal-close:hover {
    color: var(--text-color);
  }

  .captcha-modal-body {
    margin-top: 1rem;
  }

  .captcha-modal-body p {
    margin-bottom: 1.5rem;
    color: var(--text-secondary-color);
    text-align: center;
  }

  #captchaFieldContainer {
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  #captchaFieldContainer label {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.5rem;
  }

  #captchaFieldContainer input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--background-color);
    color: var(--text-color);
    font-size: 1rem;
    text-align: center;
    letter-spacing: 0.2em;
  }

  #captchaFieldContainer img {
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .captcha-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  .captcha-modal-actions .btn {
    flex: 1;
    padding: 0.75rem 1.5rem;
  }

  .btn-secondary {
    background-color: var(--text-secondary-color);
    color: white;
    border: none;
  }

  .btn-secondary:hover {
    background-color: var(--text-color);
    opacity: 0.9;
  }
</style>

<script>
  // تابع global برای handle کردن کلیک دکمه (fallback)
  function handleSubmitClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const contactForm = document.getElementById('contactForm');
    const captchaModal = document.getElementById('captchaModal');
    
    if (!contactForm || !captchaModal) {
      console.error('فرم یا مودال یافت نشد');
      return false;
    }
    
    // حذف فیلدهای کپچا از اعتبارسنجی فرم (چون در مودال هستند)
    const captchaInputs = contactForm.querySelectorAll('input[name^="captcha"]');
    captchaInputs.forEach(function(input) {
      input.removeAttribute('required');
    });
    
    // بررسی اعتبار فرم (بدون فیلدهای کپچا)
    if (!contactForm.checkValidity()) {
      contactForm.reportValidity();
      return false;
    }
    
    // نمایش مودال
    captchaModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // حذف required از فیلد کپچا در مودال
    const captchaFieldContainer = document.getElementById('captchaFieldContainer');
    if (captchaFieldContainer) {
      const captchaInput = captchaFieldContainer.querySelector('input[name="captcha_1"]');
      if (captchaInput) {
        captchaInput.removeAttribute('required');
      }
    }
    
    // به‌روزرسانی آیکون‌های feather
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
    
    return false;
  }
  
  (function() {
    'use strict';
    
    // مدیریت مودال کپچا
    function initCaptchaModal() {
      const contactForm = document.getElementById('contactForm');
      const submitBtn = document.getElementById('submitBtn');
      const captchaModal = document.getElementById('captchaModal');
      const closeCaptchaModal = document.getElementById('closeCaptchaModal');
      const cancelCaptchaBtn = document.getElementById('cancelCaptchaBtn');
      const confirmCaptchaBtn = document.getElementById('confirmCaptchaBtn');
      const captchaFieldContainer = document.getElementById('captchaFieldContainer');
      
      // دیباگ: بررسی وجود المان‌ها
      console.log('contactForm:', contactForm);
      console.log('submitBtn:', submitBtn);
      console.log('captchaModal:', captchaModal);
      
      if (!contactForm || !submitBtn || !captchaModal) {
        console.error('برخی المان‌های مورد نیاز یافت نشدند!');
        return;
      }
      
      // حذف فیلدهای کپچا از فرم اصلی (اگر وجود داشته باشند)
      const captchaInputsInForm = contactForm.querySelectorAll('input[name^="captcha"]');
      captchaInputsInForm.forEach(function(input) {
        input.removeAttribute('required');
        // اگر در یک container خاص است، آن را حذف نکن (ممکن است در مودال باشد)
        if (!input.closest('#captchaFieldContainer')) {
          input.style.display = 'none';
        }
      });
      
      // نمایش مودال کپچا
      function showCaptchaModal() {
        captchaModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // حذف required از فیلد کپچا در مودال (چون در فرم اصلی نیست و باید به صورت دستی بررسی شود)
        if (captchaFieldContainer) {
          const captchaInput = captchaFieldContainer.querySelector('input[name="captcha_1"]');
          if (captchaInput) {
            captchaInput.removeAttribute('required');
          }
          // همچنین required را از فیلد hidden key هم بردار
          const captchaKey = captchaFieldContainer.querySelector('input[name="captcha_0"]');
          if (captchaKey) {
            captchaKey.removeAttribute('required');
          }
        }
        
        // به‌روزرسانی آیکون‌های feather
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }
      
      // بستن مودال کپچا
      function hideCaptchaModal() {
        captchaModal.style.display = 'none';
        document.body.style.overflow = '';
      }
      
      // ارسال فرم
      function submitForm() {
        // کپی کردن مقدار کپچا از مودال به فرم اصلی
        // captcha_0: کلید مخفی، captcha_1: ورودی کاربر
        const captchaKey = captchaFieldContainer.querySelector('input[name="captcha_0"]');
        const captchaInput = captchaFieldContainer.querySelector('input[name="captcha_1"]');
        
        if (captchaKey && captchaInput) {
          // ایجاد فیلدهای مخفی در فرم اصلی
          let hiddenCaptcha0 = document.getElementById('hidden_captcha_0');
          let hiddenCaptcha1 = document.getElementById('hidden_captcha_1');
          
          if (!hiddenCaptcha0) {
            hiddenCaptcha0 = document.createElement('input');
            hiddenCaptcha0.type = 'hidden';
            hiddenCaptcha0.name = 'captcha_0';
            hiddenCaptcha0.id = 'hidden_captcha_0';
            contactForm.appendChild(hiddenCaptcha0);
          }
          
          if (!hiddenCaptcha1) {
            hiddenCaptcha1 = document.createElement('input');
            hiddenCaptcha1.type = 'hidden';
            hiddenCaptcha1.name = 'captcha_1';
            hiddenCaptcha1.id = 'hidden_captcha_1';
            contactForm.appendChild(hiddenCaptcha1);
          }
          
          hiddenCaptcha0.value = captchaKey.value;
          hiddenCaptcha1.value = captchaInput.value;
        }
        
        hideCaptchaModal();
        contactForm.submit();
      }
      
      // رویداد کلیک روی دکمه ارسال (اگر onclick کار نکرد)
      submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('دکمه ارسال کلیک شد (از event listener)');
        
        // حذف فیلدهای کپچا از اعتبارسنجی فرم (چون در مودال هستند)
        const captchaInputs = contactForm.querySelectorAll('input[name^="captcha"]');
        captchaInputs.forEach(function(input) {
          input.removeAttribute('required');
        });
        
        // بررسی اعتبار فرم (بدون فیلدهای کپچا)
        if (!contactForm.checkValidity()) {
          console.log('فرم معتبر نیست');
          contactForm.reportValidity();
          return;
        }
        
        console.log('نمایش مودال کپچا');
        showCaptchaModal();
      });
      
      // بستن مودال با کلیک روی overlay
      captchaModal.querySelector('.captcha-modal-overlay').addEventListener('click', hideCaptchaModal);
      
      // بستن مودال با کلیک روی دکمه بستن
      if (closeCaptchaModal) {
        closeCaptchaModal.addEventListener('click', hideCaptchaModal);
      }
      
      // بستن مودال با کلیک روی دکمه انصراف
      if (cancelCaptchaBtn) {
        cancelCaptchaBtn.addEventListener('click', hideCaptchaModal);
      }
      
      // تأیید و ارسال فرم
      if (confirmCaptchaBtn) {
        confirmCaptchaBtn.addEventListener('click', function() {
          const captchaInput = captchaFieldContainer.querySelector('input[name="captcha_1"]');
          if (!captchaInput || !captchaInput.value.trim()) {
            alert('لطفاً کد امنیتی را وارد کنید.');
            return;
          }
          submitForm();
        });
      }
      
      // بستن مودال با کلید ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && captchaModal.style.display === 'flex') {
          hideCaptchaModal();
        }
      });
    }
    
    function initLanguageCards() {
      const languageItems = document.querySelectorAll('.language-item');
      
      if (languageItems.length === 0) {
        return;
      }
      
      // اضافه کردن event listener به هر language-header
      languageItems.forEach((item) => {
        const header = item.querySelector('.language-header');
        if (!header) {
          return;
        }
        
        // اضافه کردن cursor pointer
        header.style.cursor = 'pointer';
        
        // خواندن مقادیر از data attributes
        const writing = item.getAttribute('data-writing') || '0';
        const speaking = item.getAttribute('data-speaking') || '0';
        const listening = item.getAttribute('data-listening') || '0';
        
        header.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const isCurrentlyExpanded = item.classList.contains('expanded');
          
          // بستن همه آیتم‌ها
          languageItems.forEach((otherItem) => {
            if (otherItem !== item) {
              otherItem.classList.remove('expanded');
            }
          });
          
          // اگر آیتم کلیک شده باز نبود، آن را باز کن
          if (!isCurrentlyExpanded) {
            item.classList.add('expanded');
            
            // انیمیشن skill bars بعد از باز شدن
            setTimeout(function() {
              const skillFills = item.querySelectorAll('.skill-fill');
              
              skillFills.forEach(function(fill, fillIndex) {
                let widthValue;
                // خواندن از data-width یا از data attributes
                widthValue = fill.getAttribute('data-width');
                if (!widthValue) {
                  // اگر data-width نبود، از data attributes item بخوان
                  if (fillIndex === 0) widthValue = writing;
                  else if (fillIndex === 1) widthValue = speaking;
                  else if (fillIndex === 2) widthValue = listening;
                }
                
                if (widthValue) {
                  const width = widthValue + '%';
                  fill.style.width = '0%';
                  // Force reflow
                  fill.offsetHeight;
                  setTimeout(function() {
                    fill.style.width = width;
                  }, 10);
                }
              });
            }, 300);
          } else {
            item.classList.remove('expanded');
          }
          
          // به‌روزرسانی آیکون‌های feather
          setTimeout(function() {
            if (typeof feather !== 'undefined') {
              feather.replace();
            }
          }, 150);
        });
      });
    }
    
    // اجرا بعد از لود شدن صفحه
    function initializeAll() {
      console.log('شروع مقداردهی اولیه...');
      initCaptchaModal();
      initLanguageCards();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAll);
    } else {
      // اگر DOM از قبل لود شده، مستقیماً اجرا کن
      setTimeout(initializeAll, 100);
    }
    
    // همچنین بعد از لود کامل صفحه هم اجرا کن (برای اطمینان)
    window.addEventListener('load', function() {
      console.log('صفحه کاملاً لود شد');
      if (!document.getElementById('submitBtn').onclick) {
        console.log('مقداردهی مجدد...');
        initCaptchaModal();
      }
    });
  })();
</script>

{% endblock %}
